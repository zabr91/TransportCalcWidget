jQuery(function($){$(document).ready(function(){"use strict";var appSettings={map:$(".calculate-map"),center:[53.677834,23.829529],zoom:5,strokeColor:"2e3191",mapBehaviorsDisables:["drag","scrollZoom"],mapControlsRemove:["fullscreenControl","trafficControl","typeSelector","searchControl"]};var appMap,appRoute,lengthval;var inputFrom=$(".calculate-from-position__from input");var inputTo=$(".calculate-from-position__to input");var distance=$("#distance");var inputVolume=$("input#size");var inputWeight=$("input#mass");var sendBtn=$("#send-calc-result");var calcOptions=$(".calc-options");var openDialog=false;var htmlForm='<form class="tcw-form">'+"<div>"+"<label>Имя</label>"+'<input type="text" size="40"  value="" name="name" class="name" placeholder="Имя" required/>'+"</div>"+"<div>"+"<label>Телефон</label>"+'<input type="tel" size="40"  value="" name="phone" class="phone" data-grouplength="5,"  placeholder="+7(__)__-__-__" required/>'+"</div>"+"<div>"+"<label>e-mail</label>"+'<input type="email" size="40" value="" name="email" class="email" placeholder="Почта" required/>'+"</div>"+' <div class="flex">Наличныe <label class="switch"><input type="checkbox" id="formpay" value="Наличные"><span class="slider round"></span></label>Безналичные</div>'+'<label><input type="checkbox" id="apcept"/> Заполняя форму обратной связи я даю согласие на обработку своих персональных данных</label>'+"<form>";appInit();function appInit(){if(appSettings["map"]){sendBtn.prop("disabled",true);mapInit()}$(window).keydown(function(event){if(event.keyCode==13){event.preventDefault();return false}})}calcOptions.on("click",function(e){calculateDistancePrice(0)});sendBtn.on("click",function(e){e.preventDefault();$.alert({title:"Подать заявку",theme:"modern",backgroundDismiss:function(){return false},closeIcon:true,content:htmlForm,buttons:{formSubmit:{text:"Отпавить",btnClass:"btn-blue",action:function(){return sendData(this)},cancel:function(){}}}})});function mapInit(){if(!ymaps){alert("Данные ЯндексКарт не загрузились. Перезагрузите страницу")}else{ymaps.ready(function(){appMap=new ymaps.Map("map",{center:appSettings["center"],zoom:appSettings["zoom"]});appSettings["mapBehaviorsDisables"].forEach(element=>appMap.behaviors.disable(element));appSettings["mapControlsRemove"].forEach(element=>appMap.controls.remove(element));let timeout=null;inputFrom.on("input",function(){clearTimeout(timeout);timeout=setTimeout(function(){routeInit()},1e3);sendBtn.prop("disabled",true)});inputTo.on("input",function(){clearTimeout(timeout);timeout=setTimeout(function(){routeInit()},1e3);sendBtn.prop("disabled",true)});inputVolume.bind("keyup input wheel",function(){clearTimeout(timeout);timeout=setTimeout(function(){calculateDistancePrice(lengthval)},1e3)});inputWeight.bind("keyup input wheel",function(){clearTimeout(timeout);timeout=setTimeout(function(){calculateDistancePrice(lengthval)},1e3)})})}}function routeInit(){if(inputTo.val()!==""&&inputFrom.val()!==""){ymaps.route([inputFrom.val(),inputTo.val()],{multiRoute:true,mapStateAutoApply:true}).done(function(route){route.model.setParams({results:1},true);route.model.events.add("requestsuccess",function(){appMap.geoObjects.remove(appRoute);var activeRoute=route.getActiveRoute();if(activeRoute){appMap.geoObjects.add(route);length=route.getActiveRoute().properties.get("distance");lengthval=length.value/1e3;route.options.set("zoomMargin",35);route.options.set("boundsAutoApply",true);route.getRoutes().each(function(route){route.options.set({strokeColor:appSettings["strokeColor"],opacity:1})});distance.html("<span>"+parseInt(lengthval)+" км</span>");calculateDistancePrice(lengthval);appRoute=route}})},function(err){throw err},this)}}function calculateDistancePrice(distance){$("#passingcargo").html("Идет загрузка...");$.ajax({type:"GET",url:ajax_object.ajaxurl,async:false,data:{action:"get_price",distance:lengthval,weight:inputWeight.val(),volume:inputVolume.val(),options:getSelectOptions(true)},success:function(response){let responseJSON=JSON.parse(response);$("#calc-price").html(responseJSON.result.price);$("#passingcargo").html("Если груз будет попутным "+responseJSON.result.passingcargo+" руб.");sendBtn.prop("disabled",false);if(responseJSON.result.message){openDialog=true;$.alert({title:responseJSON.result.message,closeIcon:true,theme:"modern",content:htmlForm,buttons:{formSubmit:{text:"Отправить",btnClass:"btn-blue",action:function(){return sendData(this)},cancel:function(){}}}})}}});return true}function validateField(thisform,selector,patern){let value=thisform.$content.find(selector).val();let regEx=new RegExp(patern);let validate=regEx.test(value);if(!validate){thisform.$content.find(selector).css("border","solid 2px red");return false}else{thisform.$content.find(selector).css("border","none");return true}}function sendData(thisform){let apceptChk=thisform.$content.find("#apcept");if(apceptChk.prop("checked")){if(!validateField(thisform,".name","^[A-Za-zА-ЯЁа-яё]{2,60}(.[A-Za-zА-ЯЁа-яё]{2,60})?(.?[A-Za-zА-ЯЁа-яё]{2,60})?$")){return false}if(!validateField(thisform,".phone","^[\\d+()\\s]{7,30}$")){return false}if(!validateField(thisform,".email","^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\\.[a-zA-Z0-9-]+)*$")){return false}let name=thisform.$content.find(".name").val();let phone=thisform.$content.find(".phone").val();let email=thisform.$content.find(".email").val();let formpay="Наличный рассчет";if($("#formpay").is(":checked")==true){formpay="Безналичный рассчет"}$.ajax({type:"POST",url:ajax_object.ajaxurl,data:{action:"send_data",name:name,phone:phone,email:email,from:inputFrom.val(),to:inputTo.val(),weight:inputWeight.val(),volume:inputVolume.val(),distance:distance.text(),price:$("#calc-price").text(),options:getSelectOptions(false),formpay:formpay},success:function(response){if(response==1){$.alert({title:"Сообщение принято",content:"Наш менеджер свяжется с Вами в ближайшее время.",theme:"material"})}}})}else{alert("Для отправки формы необходимо согласится с обработкой персональных данных");return false}return true}function getSelectOptions(arr=true){let calcOptionsChk=$(".calc-options:checked");let countChekedOptions=calcOptionsChk.length;let options=[];let str="";if(countChekedOptions>0){for(let i=0;i<countChekedOptions;i++){if(arr==true){options.push($(calcOptionsChk[i]).data())}else{str+=$(calcOptionsChk[i]).val()}}}if(arr==true){return JSON.stringify(options)}else{return str}}function mask(element,condition){var preloader='<div class="preloader-holder"><div class="lds-roller"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>';if(condition==true){$(element).css("position","relative");$(element).append(preloader).fadeIn(300)}if(condition==false){$(".preloader-holder").fadeOut(300)}}})});